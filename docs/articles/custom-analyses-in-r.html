<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Analyses in R • HuntFishApp</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Custom Analyses in R">
<meta property="og:description" content="HuntFishApp">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-48496439-4"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-48496439-4');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">HuntFishApp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/custom-analyses-in-r.html">Custom Analyses in R</a>
    </li>
    <li>
      <a href="../articles/installation-and-setup.html">Installation and Setup</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="custom-analyses-in-r_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Custom Analyses in R</h1>
                        <h4 class="author">Nathaniel Price</h4>
            
            <h4 class="date">2020-08-25</h4>
      
      
      <div class="hidden name"><code>custom-analyses-in-r.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The same functions that are used in the interactive web-based application to extract, analyze, and plot data are also accessible from R. These functions provide a basic framework for creating custom analyses. These functions can be used in R scripts to perform data analysis or in combination with R Markdown to create reports in a variety of formats. This vignette is itself an example of an R Markdown report.</p>
</div>
<div id="analysis-framework" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-framework" class="anchor"></a>Analysis Framework</h2>
<div id="step-1-load-data" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-load-data" class="anchor"></a>Step 1: Load data</h3>
<p>The first step in writing a custom analysis is to load the data from the database. To faciliate this step the huntfishapp package provides the <code>filterData</code> function. Please refer to the function’s help file for all the details on using this function (<code><a href="../reference/filterData.html">?filterData</a></code>) . The <code>filterData</code> function takes three inputs: (1) a data source specification (<code>dataSource</code>), (2) a connection to the database (<code>conn</code>), (3) a list of data filters (<code>activeFilters</code>).</p>
<p>To create a connection we first must add an ODBC data source under the name “HuntFishApp” and specify the IP address of the database server. Please refer to relevant documentation for your operating system (e.g., <a href="https://support.office.com/en-us/article/administer-odbc-data-sources-b19f856b-5b9b-48c9-8b93-07484bfab5a7">Microsoft Administer ODBC data sources</a>) and contact your database administrator if you need assistance. This data source is the same as that used by the web-based application. The database should contain a view “huntfishapp”. After creating the ODBC data source we can create a connection in R using the code below. The package <a href="https://cran.r-project.org/package=keyring">keyring</a> is used to avoid disclosing the password in the R code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># Database connection</span>
<span class="kw">conn</span> <span class="op">&lt;-</span> <span class="kw">DBI</span>::<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(<span class="kw">odbc</span>::<span class="fu"><a href="https://rdrr.io/pkg/odbc/man/odbc.html">odbc</a></span>(),
                        dsn = <span class="st">"HuntFishApp"</span>, 
                        uid = <span class="kw">keyring</span>::<span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_get</a></span>(<span class="st">"HuntFishAppUID"</span>), 
                        pwd = <span class="kw">keyring</span>::<span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_get</a></span>(<span class="st">"HuntFishAppPWD"</span>))
</pre></div>
<p>Next, we need to specify any data filters (see help file <code><a href="../reference/filterData.html">?filterData</a></code>). Here we specify that we only wish to include resident deer and fish permits for permit years between 2010 and 2018.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">activeFilters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(itemResidency = <span class="st">"T"</span>,
                      itemType = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Deer"</span>, <span class="st">"Fish"</span>),
                      itemYear = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2010</span>, <span class="fl">2018</span>))
</pre></div>
<p>Finally, we are ready to call <code>filterData</code> to create a SQL query. We will preview the results using the <code>glimpse</code> function from the dplyr package, but will not load the data in R yet. Note that in this vignette we specify <code>dataSource = "csv"</code> for demonstration purposes, but in general <code>dataSource = "sql"</code> should be used.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># Build SQL query to load data</span>
<span class="kw">permits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterData.html">filterData</a></span>(dataSource = <span class="st">"csv"</span>, activeFilters = <span class="kw">activeFilters</span>)

<span class="co"># Preview query result</span>
<span class="kw">permits</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span>()
<span class="co">#&gt; Rows: 25,288</span>
<span class="co">#&gt; Columns: 18</span>
<span class="co">#&gt; $ itemUID       &lt;int&gt; 3341, 3342, 8705, 8706, 15257, 19648, 19649, 24874, 248…</span>
<span class="co">#&gt; $ issueDate     &lt;date&gt; 2010-08-23, 2010-08-23, 2011-08-12, 2011-08-12, 2012-1…</span>
<span class="co">#&gt; $ itemResidency &lt;chr&gt; "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", …</span>
<span class="co">#&gt; $ duration      &lt;chr&gt; "Season", "Season", "Season", "Season", "Season", "Seas…</span>
<span class="co">#&gt; $ durationValue &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span>
<span class="co">#&gt; $ residency     &lt;chr&gt; "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", "T", …</span>
<span class="co">#&gt; $ state         &lt;chr&gt; "NE", "NE", "NE", "NE", "NE", "NE", "NE", "NE", "NE", "…</span>
<span class="co">#&gt; $ itemType      &lt;chr&gt; "Deer", "Deer", "Deer", "Deer", "Deer", "Deer", "Deer",…</span>
<span class="co">#&gt; $ itemYear      &lt;int&gt; 2010, 2010, 2011, 2011, 2012, 2013, 2013, 2014, 2014, 2…</span>
<span class="co">#&gt; $ price         &lt;dbl&gt; 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 31, 88, 37, 30,…</span>
<span class="co">#&gt; $ birthYear     &lt;dbl&gt; 1950, 1950, 1950, 1950, 1950, 1950, 1950, 1950, 1950, 1…</span>
<span class="co">#&gt; $ gender        &lt;chr&gt; "Male", "Male", "Male", "Male", "Male", "Male", "Male",…</span>
<span class="co">#&gt; $ county        &lt;chr&gt; "merrick", "merrick", "merrick", "merrick", "merrick", …</span>
<span class="co">#&gt; $ customerUID   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2…</span>
<span class="co">#&gt; $ age           &lt;dbl&gt; 60, 60, 61, 61, 62, 63, 63, 64, 64, 65, 66, 67, 68, 54,…</span>
<span class="co">#&gt; $ ageGroup      &lt;chr&gt; "55-64", "55-64", "55-64", "55-64", "55-64", "55-64", "…</span>
<span class="co">#&gt; $ month         &lt;dbl&gt; 8, 8, 8, 8, 10, 8, 8, 8, 8, 11, 9, 11, 10, 9, 10, 11, 1…</span>
<span class="co">#&gt; $ year          &lt;dbl&gt; 2010, 2010, 2011, 2011, 2012, 2013, 2013, 2014, 2014, 2…</span>
</pre></div>
</div>
<div id="step-2-perform-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-perform-analysis" class="anchor"></a>Step 2: Perform analysis</h3>
<p>After we are setup to load the data, we can start to design our analysis. Several analysis functions are provided. For example, we can use the <code>countCustomers</code> function to count the number of individual within a specified group (‘See Also’ section of help file lists other analysis functions <code><a href="../reference/countCustomers.html">?countCustomers</a></code>). The <code>countCustomers</code> function has two inputs: (1) the permit data (<code>df</code>) and (2) a list of grouping variables (<code>groupVars</code>). Here we specify that we wish to count customers for groups defined by gender, item type, and item year.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># Pass data through analysis function</span>
<span class="kw">permitsSummary</span> <span class="op">&lt;-</span> 
  <span class="kw">permits</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/countCustomers.html">countCustomers</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"gender"</span>, <span class="st">"itemType"</span>, <span class="st">"itemYear"</span>))

<span class="co"># Preview results</span>
<span class="kw">permitsSummary</span>
<span class="co">#&gt; # A tibble: 36 x 4</span>
<span class="co">#&gt;    gender itemType itemYear customers</span>
<span class="co">#&gt;    &lt;fct&gt;  &lt;fct&gt;    &lt;fct&gt;        &lt;int&gt;</span>
<span class="co">#&gt;  1 Female Deer     2010           113</span>
<span class="co">#&gt;  2 Female Deer     2011           120</span>
<span class="co">#&gt;  3 Female Deer     2012           117</span>
<span class="co">#&gt;  4 Female Deer     2013           114</span>
<span class="co">#&gt;  5 Female Deer     2014           122</span>
<span class="co">#&gt;  6 Female Deer     2015           118</span>
<span class="co">#&gt;  7 Female Deer     2016           127</span>
<span class="co">#&gt;  8 Female Deer     2017           114</span>
<span class="co">#&gt;  9 Female Deer     2018           111</span>
<span class="co">#&gt; 10 Female Fish     2010           328</span>
<span class="co">#&gt; # … with 26 more rows</span>
</pre></div>
</div>
<div id="step-3-plot-results" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-plot-results" class="anchor"></a>Step 3: Plot results</h3>
<p>After performing the analysis, we may wish to create a plot of the results. Several plot functions are provided. The <code>buildBarPlot</code> function is used to create a stacked bar graph (‘See Also’ section of help file lists other plot functions <code><a href="../reference/buildBarPlot.html">?buildBarPlot</a></code>). Here we create a bar graph with permit year as the x-variable, number of customers as the y-variable, gender as the fill color, and subplots for each permit type.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># Stacked bar graph by permit year</span>
<span class="fu"><a href="../reference/buildBarPlot.html">buildBarPlot</a></span>(<span class="kw">permitsSummary</span>,
             x = <span class="st">"itemYear"</span>,
             y = <span class="st">"customers"</span>,
             fill = <span class="st">"gender"</span>,
             facet = <span class="st">"itemType"</span>,
             title = <span class="st">"Number of customers (resident permits only)"</span>,
             facetScales = <span class="st">"fixed"</span>,
             scaleLabels = <span class="fu">waiver</span>())
<span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span>
</pre></div>
<p><img src="custom-analyses-in-r_files/figure-html/plotResult-1.png" width="672"></p>
</div>
<div id="step-4-repeat" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-repeat" class="anchor"></a>Step 4: Repeat</h3>
<p>Once we understand the basic steps in the framework it is easy to design and perform custom analyses. Here we put all the steps together to create a line plot indicating the churn rate of deer hunters over time in Lancaster and Douglas counties.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># Build SQL query, analyze data, plot results</span>
<span class="fu"><a href="../reference/filterData.html">filterData</a></span>(dataSource = <span class="st">"csv"</span>, 
                     activeFilters = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(itemYear = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2010</span>, <span class="fl">2018</span>),
                                          itemType = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Deer"</span>),
                                          county = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Lancaster"</span>, <span class="st">"Douglas"</span>),
                                          itemResidency = <span class="st">"T"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/calcChurn.html">calcChurn</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"county"</span>)) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(itemYear = <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw">itemYear</span>))) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/buildLinePlot.html">buildLinePlot</a></span>(x = <span class="st">"itemYear"</span>,
                y = <span class="st">"churnRate"</span>,
                fill = <span class="st">"county"</span>,
                title = <span class="st">"Deer hunter churn rate"</span>)
<span class="co">#&gt; Warning: `expand_scale()` is deprecated; use `expansion()` instead.</span>
</pre></div>
<p><img src="custom-analyses-in-r_files/figure-html/buildAnalyzePlot-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Christopher Chizinski, Nathaniel Price, Kevin Pope, Joseph Fotaine.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
